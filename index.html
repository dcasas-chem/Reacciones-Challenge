<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reacciones Orgánicas Challenge</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Lexend -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Paletas de colores para cada nivel */
        body[data-theme="level-1"] {
            --theme-color-600: #0d9488; /* teal-600 */
            --theme-bg-from: #a7f3d0; /* emerald-200 */
            --theme-bg-to: #a5f3fc; /* cyan-200 */
            --btn-gradient-from: #14b8a6; /* teal-500 */
            --btn-gradient-to: #059669; /* emerald-600 */
            --theme-shadow-color: rgba(20, 184, 166, 0.4);
            --hover-border-color: #5eead4; /* teal-300 */
        }
        body[data-theme="level-2"] {
            --theme-color-600: #f97316; /* orange-600 */
            --theme-bg-from: #fde68a; /* amber-200 */
            --theme-bg-to: #fed7aa; /* orange-200 */
            --btn-gradient-from: #f59e0b; /* amber-500 */
            --btn-gradient-to: #ea580c; /* orange-600 */
            --theme-shadow-color: rgba(245, 158, 11, 0.4);
            --hover-border-color: #fcd34d; /* amber-300 */
        }
        body[data-theme="level-3"] {
            --theme-color-600: #7c3aed; /* violet-600 */
            --theme-bg-from: #d8b4fe; /* purple-300 */
            --theme-bg-to: #f9a8d4; /* pink-300 */
            --btn-gradient-from: #8b5cf6; /* violet-500 */
            --btn-gradient-to: #d946ef; /* fuchsia-500 */
            --theme-shadow-color: rgba(139, 92, 246, 0.4);
            --hover-border-color: #c084fc; /* purple-400 */
        }

        :root {
            --accent-color: #22d3ee; /* cyan-400 */
            --correct-color: #22c55e; /* green-500 */
            --incorrect-color: #ef4444; /* red-500 */
            --card-bg-color: rgba(255, 255, 255, 0.75);
            --card-border-color: rgba(255, 255, 255, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Lexend', sans-serif; 
            background-image: linear-gradient(135deg, var(--theme-bg-from), var(--theme-bg-to)); 
            transition: background-image 0.5s ease-in-out;
        }
        
        .glass-container {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--card-border-color);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
        }

        .btn-primary { 
            background: linear-gradient(to right, var(--btn-gradient-from), var(--btn-gradient-to)); 
            transition: transform 0.2s, box-shadow 0.2s, background 0.5s; 
        }
        .btn-primary:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 6px 12px -1px var(--theme-shadow-color); 
        }
        
        .selector-btn {
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .selector-btn:hover { border-color: var(--hover-border-color); }

        /* Estilos de nivel por defecto (antes de seleccionar) */
        #level-selector button[data-level="1"] { border-color: #5eead4; }
        #level-selector button[data-level="1"] .font-bold { color: #0d9488; }
        #level-selector button[data-level="2"] { border-color: #fcd34d; }
        #level-selector button[data-level="2"] .font-bold { color: #f97316; }
        #level-selector button[data-level="3"] { border-color: #c084fc; }
        #level-selector button[data-level="3"] .font-bold { color: #7c3aed; }
        
        #level-selector .selector-btn.selected-option {
            background-color: var(--theme-color-600) !important;
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-color: transparent !important;
        }

        #question-count-selector .selector-btn.selected-option {
            background-color: var(--theme-color-600);
            color: white;
        }
        
        /* Reglas para el botón seleccionado con mayor especificidad */
        #level-selector .selector-btn.selected-option .font-bold,
        #level-selector .selector-btn.selected-option .description { 
            color: white; 
        }
        #level-selector .selector-btn.selected-option .description {
             opacity: 0.9;
        }

        .text-theme { color: var(--theme-color-600); transition: color 0.5s; }
        .ring-theme:focus { --tw-ring-color: var(--theme-color-600); }
        .text-accent { color: var(--accent-color); }
        .border-correct { border-color: var(--correct-color); }
        .border-incorrect { border-color: var(--incorrect-color); }
        .text-correct { color: var(--correct-color); }
        .text-incorrect { color: var(--incorrect-color); }
        
        .reaction-formula sub { font-size: 0.75em; }
        .reaction-formula { letter-spacing: 0.5px; }

        #progress-bar-fill {
            background-color: var(--accent-color);
            transition: width 0.4s ease-in-out;
        }

        #confirmation-modal { transition: opacity 0.3s ease-in-out; }
        #confirmation-modal-dialog { transition: transform 0.3s ease-in-out; }

    </style>
</head>
<body data-theme="level-1" class="min-h-screen flex items-center justify-center p-4">

    <!-- Menú Principal -->
    <div id="main-menu" class="glass-container p-8 rounded-2xl w-full max-w-xl text-center transition-transform duration-300">
        <h1 class="text-4xl font-extrabold text-theme mb-2">Reacciones Orgánicas</h1>
        <p class="text-xl font-bold text-gray-600 mb-6">Challenge</p>
        
        <div class="mb-6 bg-white/30 p-4 rounded-lg max-w-md mx-auto">
            <h3 class="text-md font-bold text-gray-700 mb-2">Marcador General</h3>
            <div id="stats-display" class="text-gray-700 text-sm flex justify-center items-center space-x-4"></div>
            <button id="reset-stats-btn" class="mt-2 text-xs text-gray-500 hover:text-red-500 transition-colors">Reiniciar</button>
        </div>
        
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Nivel de Dificultad</h3>
            <div id="level-selector" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button data-level="1" class="selector-btn flex-1 p-4 rounded-lg bg-white/50 border-2 text-gray-700 font-semibold">
                    <span class="block font-bold">Nivel 1</span>
                    <span class="description block text-sm text-gray-500 mt-1">Completa la reacción</span>
                </button>
                <button data-level="2" class="selector-btn flex-1 p-4 rounded-lg bg-white/50 border-2 text-gray-700 font-semibold">
                    <span class="block font-bold">Nivel 2</span>
                    <span class="description block text-sm text-gray-500 mt-1">Identifica y completa</span>
                </button>
                <button data-level="3" class="selector-btn flex-1 p-4 rounded-lg bg-white/50 border-2 text-gray-700 font-semibold">
                    <span class="block font-bold">Nivel 3</span>
                    <span class="description block text-sm text-gray-500 mt-1">Demuestra lo que sabes</span>
                </button>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-700 mb-3">Número de Ejercicios</h3>
            <div id="question-count-selector" class="flex justify-center space-x-2 bg-gray-200/50 rounded-full p-1">
                <button data-count="5" class="selector-btn px-5 py-2 rounded-full text-gray-600 font-semibold">5</button>
                <button data-count="10" class="selector-btn px-5 py-2 rounded-full text-gray-600 font-semibold">10</button>
                <button data-count="15" class="selector-btn px-5 py-2 rounded-full text-gray-600 font-semibold">15</button>
                <button data-count="20" class="selector-btn px-5 py-2 rounded-full text-gray-600 font-semibold">20</button>
            </div>
        </div>

        <button id="start-game-btn" class="btn-primary text-white font-bold py-3 px-12 rounded-full text-lg shadow-lg">Empezar</button>
    </div>

    <!-- El resto del HTML (vistas de juego, game over, modal) permanece sin cambios -->
    <!-- Vista de Juego -->
    <div id="game-view" class="glass-container p-8 rounded-2xl w-full max-w-2xl hidden transition-transform duration-300">
        <div class="flex items-center justify-between mb-2">
            <button id="back-btn" class="text-gray-500 hover:text-gray-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <span id="score-display" class="text-lg font-bold text-gray-700">Puntuación: 0</span>
            <span id="question-count" class="text-lg font-bold text-accent">1/10</span>
        </div>
        <div class="h-2 bg-gray-200/50 rounded-full mb-6">
            <div id="progress-bar-fill" class="h-full rounded-full" style="width: 0%;"></div>
        </div>
        
        <div class="bg-white/50 rounded-lg p-6 mb-6 text-center shadow-inner">
            <p id="reaction-text" class="text-2xl md:text-3xl font-bold text-gray-800 reaction-formula">CH<sub>3</sub>-CH<sub>2</sub>-OH + HBr → ?</p>
        </div>
        
        <div id="inputs-container" class="text-left">
            <!-- Los inputs se generan dinámicamente aquí -->
        </div>

        <button id="check-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-full text-lg mt-8 w-full shadow-lg">Comprobar</button>
        
        <div id="feedback-display" class="mt-6 hidden">
            <h2 id="feedback-message" class="text-2xl font-bold mb-4"></h2>
            <div id="correct-answer" class="text-base text-gray-700 mb-6 text-left p-4 rounded-lg bg-gray-100/80 border border-gray-300/50"></div>
            <button id="next-question-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-full text-lg w-full shadow-lg">Siguiente</button>
        </div>
    </div>

    <!-- Vista de Fin de Juego -->
    <div id="game-over" class="glass-container p-8 rounded-2xl w-full max-w-md text-center hidden transition-transform duration-300">
        <h2 class="text-3xl font-bold text-theme mb-4">¡Partida Terminada!</h2>
        <p id="final-score" class="text-xl text-gray-700 mb-8"></p>
        <div class="flex space-x-4">
            <button id="main-menu-btn" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-full transition hover:bg-gray-300">Menú Principal</button>
            <button id="play-again-btn" class="flex-1 btn-primary text-white font-bold py-3 px-6 rounded-full shadow-lg">Jugar de Nuevo</button>
        </div>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="confirmation-modal-dialog" class="glass-container p-8 rounded-2xl w-full max-w-sm text-center transform scale-95">
            <h3 class="text-xl font-bold text-gray-800 mb-4">¿Estás seguro?</h3>
            <p class="text-gray-600 mb-6">Esta acción borrará todas tus estadísticas de forma permanente.</p>
            <div class="flex space-x-4">
                <button id="confirm-reset-btn" class="flex-1 bg-red-500 text-white font-bold py-3 px-6 rounded-full transition hover:bg-red-600">Sí, borrar</button>
                <button id="cancel-reset-btn" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-full transition hover:bg-gray-300">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS DE REACCIONES (MISMA BASE AMPLIADA) ---
        const organicReactions = [
             // Halogenuros de Alquilo
            { id: 1, reaction: 'CH<sub>3</sub>-CH<sub>3</sub> + Cl<sub>2</sub> → ? + HCl', product: 'CH<sub>3</sub>-CH<sub>2</sub>Cl', compoundName: 'Cloroetano', reactionType: 'Sustitución', category: 'Halogenación', catalyst: 'Luz UV', type: 'complete' },
            { id: 2, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-OH + HBr → ? + H<sub>2</sub>O', product: 'CH<sub>3</sub>-CH<sub>2</sub>-Br', compoundName: 'Bromoetano', reactionType: 'Sustitución', category: 'Halogenación', catalyst: '—', type: 'complete' },
            { id: 3, reaction: 'CH<sub>3</sub>-CH=CH<sub>2</sub> + HCl → ?', product: 'CH<sub>3</sub>-CHCl-CH<sub>3</sub>', compoundName: '2-Cloropropano', reactionType: 'Adición', category: 'Haluro de hidrógeno', catalyst: '-', type: 'complete' },
            { id: 4, reaction: 'CH<sub>2</sub>=CH<sub>2</sub> + Br<sub>2</sub> → ?', product: 'BrCH<sub>2</sub>-CH<sub>2</sub>Br', compoundName: '1,2-Dibromoetano', reactionType: 'Adición', category: 'Halogenación', catalyst: '—', type: 'complete' },
            { id: 5, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-Br + NaOH(aq) → ? + NaBr', product: 'CH<sub>3</sub>-CH<sub>2</sub>-OH', compoundName: 'Etanol', reactionType: 'Sustitución', category: 'Hidrólisis', catalyst: '—', type: 'complete' },
            { id: 6, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-Br + KOH(alcohol) → ? + KBr + H<sub>2</sub>O', product: 'CH<sub>2</sub>=CH<sub>2</sub>', compoundName: 'Eteno', reactionType: 'Eliminación', category: 'Deshidrohalogenación', catalyst: 'Calor', type: 'complete' },
            // Alcoholes
            { id: 7, reaction: 'CH<sub>3</sub>-CH=CH<sub>2</sub> + H<sub>2</sub>O → ?', product: 'CH<sub>3</sub>-CH(OH)-CH<sub>3</sub>', compoundName: 'Propan-2-ol', reactionType: 'Adición', category: 'Hidratación', catalyst: 'H+', type: 'complete' },
            { id: 8, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-OH + H<sub>2</sub>SO<sub>4</sub>(conc) → ? + H<sub>2</sub>O', product: 'CH<sub>2</sub>=CH<sub>2</sub>', compoundName: 'Eteno', reactionType: 'Eliminación', category: 'Deshidratación', catalyst: '180°C', type: 'complete' },
            { id: 9, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-OH + [O] → ?', product: 'CH<sub>3</sub>-CHO', compoundName: 'Etanal', reactionType: 'Oxidación', category: 'Alcohol Primario', catalyst: 'K<sub>2</sub>Cr<sub>2</sub>O<sub>7</sub>/H+', type: 'complete' },
            { id: 10, reaction: 'CH<sub>3</sub>-CH(OH)-CH<sub>3</sub> + [O] → ?', product: 'CH<sub>3</sub>-CO-CH<sub>3</sub>', compoundName: 'Propanona', reactionType: 'Oxidación', category: 'Alcohol Secundario', catalyst: 'KMnO<sub>4</sub>/H+', type: 'complete' },
            { id: 11, reaction: '2 CH<sub>3</sub>-CH<sub>2</sub>-OH + H<sub>2</sub>SO<sub>4</sub>(conc) → ? + H<sub>2</sub>O', product: 'CH<sub>3</sub>-CH<sub>2</sub>-O-CH<sub>2</sub>-CH<sub>3</sub>', compoundName: 'Dietil éter', reactionType: 'Sustitución', category: 'Formación de éter', catalyst: 'H<sub>2/S/O<sub>4', type: 'complete' },
            // Aldehídos y Cetonas
            { id: 12, reaction: 'CH<sub>3</sub>-CHO + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-OH', compoundName: 'Etanol', reactionType: 'Reducción', category: 'Hidrogenación', catalyst: 'Ni/Pt/Pd', type: 'complete' },
            { id: 13, reaction: 'CH<sub>3</sub>-CO-CH<sub>3</sub> + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH(OH)-CH<sub>3</sub>', compoundName: 'Propan-2-ol', reactionType: 'Reducción', category: 'Hidrogenación', catalyst: 'LiAlH<sub>4</sub>/NaBH<sub>4</sub>', type: 'complete' },
            { id: 14, reaction: 'CH<sub>3</sub>-CHO + [O] → ?', product: 'CH<sub>3</sub>-COOH', compoundName: 'Ácido etanoico', reactionType: 'Oxidación', category: 'Oxidación de aldehído', catalyst: '[Ag(NH<sub>3</sub>)<sub>2</sub>]+', type: 'complete' },
            { id: 15, reaction: 'CH≡CH + H<sub>2</sub>O → ?', product: 'CH<sub>3</sub>-CHO', compoundName: 'Etanal', reactionType: 'Adición', category: 'Hidratación de alquinos', catalyst: 'HgSO<sub>4</sub>/H<sub>2</sub>SO<sub>4</sub>', type: 'complete' },
            // Ácidos Carboxílicos y Derivados
            { id: 16, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>OH + [O] fuerte → ?', product: 'CH<sub>3</sub>-COOH', compoundName: 'Ácido etanoico', reactionType: 'Oxidación', category: 'Alcohol Primario', catalyst: 'KMnO<sub>4</sub>', type: 'complete' },
            { id: 17, reaction: 'CH<sub>3</sub>-COOH + CH<sub>3</sub>OH ↔ ? + H<sub>2</sub>O', product: 'CH<sub>3</sub>-COO-CH<sub>3</sub>', compoundName: 'Etanoato de metilo', reactionType: 'Esterificación', category: '-', catalyst: 'H+', type: 'complete' },
            { id: 18, reaction: 'CH<sub>3</sub>-COO-CH<sub>2</sub>CH<sub>3</sub> + NaOH → ? + CH<sub>3</sub>CH<sub>2</sub>OH', product: 'CH<sub>3</sub>-COONa', compoundName: 'Etanoato de sodio', reactionType: 'Hidrólisis', category: 'Saponificación', catalyst: 'Calor', type: 'complete' },
            { id: 19, reaction: 'CH<sub>3</sub>-COOH + NaOH → ? + H<sub>2</sub>O', product: 'CH<sub>3</sub>-COONa', compoundName: 'Etanoato de sodio', reactionType: 'Neutralización', category: 'Ácido-Base', catalyst: '—', type: 'complete' },
            { id: 20, reaction: 'CH<sub>3</sub>-COOH + LiAlH<sub>4</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-OH', compoundName: 'Etanol', reactionType: 'Reducción', category: 'Reducción de Ácidos', catalyst: '1) LiAlH<sub>4</sub> 2) H<sub>3</sub>O+', type: 'complete' },
            // Hidrocarburos Aromáticos
            { id: 21, reaction: 'C<sub>6</sub>H<sub>6</sub> + HNO<sub>3</sub> → ? + H<sub>2</sub>O', product: 'C<sub>6</sub>H<sub>5</sub>-NO<sub>2</sub>', compoundName: 'Nitrobenceno', reactionType: 'Sustitución', category: 'Nitración', catalyst: 'H<sub>2</sub>SO<sub>4</sub>', type: 'complete' },
            { id: 22, reaction: 'C<sub>6</sub>H<sub>6</sub> + Br<sub>2</sub> → ? + HBr', product: 'C<sub>6</sub>H<sub>5</sub>Br', compoundName: 'Bromobenceno', reactionType: 'Sustitución', category: 'Halogenación', catalyst: 'FeBr<sub>3</sub>', type: 'complete' },
            { id: 23, reaction: 'C<sub>6</sub>H<sub>6</sub> + CH<sub>3</sub>Cl → ? + HCl', product: 'C<sub>6</sub>H<sub>5</sub>-CH<sub>3</sub>', compoundName: 'Tolueno', reactionType: 'Sustitución', category: 'Alquilación', catalyst: 'AlCl<sub>3</sub>', type: 'complete' },
            { id: 24, reaction: 'C<sub>6</sub>H<sub>5</sub>-CH<sub>3</sub> + [O] → ?', product: 'C<sub>6</sub>H<sub>5</sub>-COOH', compoundName: 'Ácido benzoico', reactionType: 'Oxidación', category: 'Cadena lateral', catalyst: 'KMnO<sub>4</sub>/Calor', type: 'complete' },
            // Reacciones Variadas y de Nivel 3 (Reverse)
            { id: 25, reaction: '? + H<sub>2</sub>(exceso) → CH<sub>3</sub>CH<sub>2</sub>CH<sub>3</sub>', product: 'CH<sub>3</sub>-C≡CH', compoundName: 'Propino', reactionType: 'Adición', category: 'Hidrogenación', catalyst: 'Pt/Pd/Ni', type: 'reverse' },
            { id: 26, reaction: '? + H<sub>2</sub>O → CH<sub>3</sub>COOH + CH<sub>3</sub>OH', product: 'CH<sub>3</sub>-COO-CH<sub>3</sub>', compoundName: 'Etanoato de metilo', reactionType: 'Hidrólisis Ácida', category: 'Esterificación', catalyst: 'H+', type: 'reverse' },
            { id: 27, reaction: '? → C<sub>6</sub>H<sub>5</sub>-NO<sub>2</sub>', product: 'C<sub>6</sub>H<sub>6</sub>', compoundName: 'Benceno', reactionType: 'Nitración', category: null, catalyst: 'HNO<sub>3</sub>/H<sub>2</sub>SO<sub>4</sub>', type: 'reverse' },
            { id: 28, reaction: 'CH<sub>4</sub> + 2 O<sub>2</sub> → ? + ?', product: 'CO<sub>2</sub> + 2 H<sub>2</sub>O', compoundName: 'Dióxido de carbono y Agua', reactionType: 'Combustión', category: 'Combustión', catalyst: '—', type: 'complete' },
            { id: 29, reaction: 'n(CH<sub>2</sub>=CH<sub>2</sub>) → ?', product: '-(CH<sub>2</sub>-CH<sub>2</sub>)-n', compoundName: 'Polietileno', reactionType: 'Polimerización', category: 'Adición', catalyst: 'Iniciador', type: 'complete' },
            { id: 30, reaction: 'CH<sub>3</sub>-C≡CH + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH=CH<sub>2</sub>', compoundName: 'Propeno', reactionType: 'Adición', category: 'Hidrogenación', catalyst: '-', type: 'complete' },
            { id: 72, reaction: '? + HBr (peróxidos) → CH<sub>3</sub>CH<sub>2</sub>CH<sub>2</sub>Br', product: 'CH<sub>3</sub>-CH=CH<sub>2</sub>', compoundName: 'Propeno', reactionType: 'Adición', category: 'Hidrohalogenación Anti-Markovnikov', catalyst: 'ROOR', type: 'reverse' }
        ];
        
        // --- ESTADO DEL JUEGO ---
        let gameState = {
            currentQuestion: 0,
            score: 0,
            questions: [],
            totalQuestions: 10,
            level: 1,
            currentReaction: null,
        };

        // --- ELEMENTOS DEL DOM ---
        const DOMElements = {
            views: {
                mainMenu: document.getElementById('main-menu'),
                gameView: document.getElementById('game-view'),
                gameOver: document.getElementById('game-over')
            },
            buttons: {
                start: document.getElementById('start-game-btn'),
                back: document.getElementById('back-btn'),
                check: document.getElementById('check-btn'),
                nextQuestion: document.getElementById('next-question-btn'),
                playAgain: document.getElementById('play-again-btn'),
                mainMenu: document.getElementById('main-menu-btn'),
                resetStats: document.getElementById('reset-stats-btn'),
                confirmReset: document.getElementById('confirm-reset-btn'),
                cancelReset: document.getElementById('cancel-reset-btn'),
            },
            displays: {
                reactionText: document.getElementById('reaction-text'),
                score: document.getElementById('score-display'),
                questionCount: document.getElementById('question-count'),
                feedback: document.getElementById('feedback-display'),
                feedbackMessage: document.getElementById('feedback-message'),
                correctAnswer: document.getElementById('correct-answer'),
                finalScore: document.getElementById('final-score'),
                stats: document.getElementById('stats-display'),
                progressBar: document.getElementById('progress-bar-fill'),
            },
            inputsContainer: document.getElementById('inputs-container'),
            selectors: {
                level: document.getElementById('level-selector'),
                questionCount: document.getElementById('question-count-selector'),
            },
            modal: {
                container: document.getElementById('confirmation-modal'),
                dialog: document.getElementById('confirmation-modal-dialog'),
            }
        };
        
        // --- LÓGICA DE MANEJO DE VISTAS Y TEMAS ---
        const showView = (viewName) => {
            Object.values(DOMElements.views).forEach(v => v.classList.add('hidden'));
            DOMElements.views[viewName].classList.remove('hidden');
        };

        const setTheme = (level) => {
            document.body.dataset.theme = `level-${level}`;
        };
        
        const normalizeValue = (value) => {
            if (typeof value !== 'string') return '';
            return value.replace(/<[^>]*>|[\s-]/g, '').toLowerCase();
        };

        // --- LÓGICA DEL JUEGO ---
        const startGame = () => {
            gameState.score = 0;
            gameState.currentQuestion = 0;
            
            let filteredReactions = organicReactions;
            // Para Nivel 1 y 2, solo usar reacciones de tipo 'complete'
            if (gameState.level < 3) {
                 filteredReactions = organicReactions.filter(r => r.type === 'complete');
            }
            // Para Nivel 3, se usan todas las reacciones (la condición no se cumple)
            
            gameState.questions = [...filteredReactions].sort(() => Math.random() - 0.5).slice(0, gameState.totalQuestions);
            
            if (gameState.questions.length > 0) {
                displayNextQuestion();
                showView('gameView');
            } else {
                alert("No hay preguntas disponibles para esta configuración.");
            }
        };

        const displayNextQuestion = () => {
            if (gameState.currentQuestion >= gameState.totalQuestions) {
                endGame();
                return;
            }
            gameState.currentReaction = gameState.questions[gameState.currentQuestion];
            
            DOMElements.displays.reactionText.innerHTML = gameState.currentReaction.reaction;
            DOMElements.displays.score.textContent = `Puntuación: ${gameState.score}`;
            DOMElements.displays.questionCount.textContent = `${gameState.currentQuestion + 1}/${gameState.totalQuestions}`;
            
            renderInputsForQuestion();
            
            DOMElements.displays.feedback.classList.add('hidden');
            DOMElements.buttons.check.classList.remove('hidden');
            DOMElements.buttons.nextQuestion.classList.add('hidden');
            
            updateProgressBar();
        };

        const renderInputsForQuestion = () => {
            const { level, currentReaction } = gameState;
            let inputs = [];

            const inputTemplate = (id, label) => `
                <div class="w-full">
                    <label class="block text-gray-700 font-semibold mb-2" for="${id}">${label}:</label>
                    <input id="${id}" type="text" autocomplete="off" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none ring-theme focus:ring-2 transition-colors duration-200">
                </div>
            `;
            
            inputs.push(inputTemplate('product-input', 'Fórmula del compuesto'));
            inputs.push(inputTemplate('name-input', 'Nombre del compuesto'));

            if (level >= 2) {
                inputs.push(inputTemplate('reaction-type-input', 'Tipo de reacción'));
                if (currentReaction.category) {
                     inputs.push(inputTemplate('category-input', 'Categoría'));
                }
            }
            if (level >= 3 && currentReaction.catalyst && normalizeValue(currentReaction.catalyst) !== '—') {
                inputs.push(inputTemplate('catalyst-input', 'Catalizador'));
            }
            
            let inputsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            inputs.forEach(inputHTML => {
                inputsHTML += inputHTML;
            });
            inputsHTML += '</div>';

            DOMElements.inputsContainer.innerHTML = inputsHTML;
            
            DOMElements.inputsContainer.querySelectorAll('input').forEach(input => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (!DOMElements.buttons.check.classList.contains('hidden')) {
                            checkAnswer();
                        }
                    }
                });
            });
        };

        const checkAnswer = () => {
            const { currentReaction, level } = gameState;
            let allCorrect = true;

            const checkField = (inputId, correctValue, isMultiOption = false) => {
                const input = document.getElementById(inputId);
                if (!input) return;

                const userValue = normalizeValue(input.value);
                let isCorrect = false;

                if (isMultiOption) {
                    const correctOptions = correctValue.split('/').map(o => normalizeValue(o));
                    isCorrect = correctOptions.includes(userValue);
                } else {
                    isCorrect = userValue === normalizeValue(correctValue);
                }
                
                input.classList.add(isCorrect ? 'border-correct' : 'border-incorrect');
                input.disabled = true;
                if (!isCorrect) allCorrect = false;
            };

            checkField('product-input', currentReaction.product);
            checkField('name-input', currentReaction.compoundName);

            if (level >= 2) {
                checkField('reaction-type-input', currentReaction.reactionType);
                if (currentReaction.category) {
                    checkField('category-input', currentReaction.category);
                }
            }
            if (level >= 3 && currentReaction.catalyst && normalizeValue(currentReaction.catalyst) !== '—') {
                checkField('catalyst-input', currentReaction.catalyst, true);
            }

            if (allCorrect) {
                DOMElements.displays.feedbackMessage.textContent = '¡Correcto!';
                DOMElements.displays.feedbackMessage.className = 'text-2xl font-bold mb-4 text-correct';
                gameState.score++;
            } else {
                DOMElements.displays.feedbackMessage.textContent = 'Algunas respuestas son incorrectas';
                DOMElements.displays.feedbackMessage.className = 'text-2xl font-bold mb-4 text-incorrect';
            }
            
            displayCorrectAnswer();
            DOMElements.displays.score.textContent = `Puntuación: ${gameState.score}`;
            DOMElements.displays.feedback.classList.remove('hidden');
            DOMElements.buttons.check.classList.add('hidden');
            DOMElements.buttons.nextQuestion.classList.remove('hidden');
        };

        const displayCorrectAnswer = () => {
            const { currentReaction, level } = gameState;
            let answerHTML = `<p class="font-bold text-gray-800 mb-2">Respuesta Correcta:</p>`;
            answerHTML += `<p><strong>Fórmula:</strong> ${currentReaction.product}</p>`;
            answerHTML += `<p><strong>Nombre:</strong> ${currentReaction.compoundName}</p>`;
            if (level >= 2) {
                answerHTML += `<p><strong>Tipo:</strong> ${currentReaction.reactionType}</p>`;
                if (currentReaction.category) answerHTML += `<p><strong>Categoría:</strong> ${currentReaction.category}</p>`;
            }
            if (level >= 3 && normalizeValue(currentReaction.catalyst) !== '—') {
                 answerHTML += `<p><strong>Catalizador:</strong> ${currentReaction.catalyst}</p>`;
            }
            DOMElements.displays.correctAnswer.innerHTML = answerHTML;
        };

        const endGame = () => {
            updateStats(true);
            DOMElements.displays.finalScore.textContent = `Tu puntuación final: ${gameState.score} de ${gameState.totalQuestions}.`;
            showView('gameOver');
        };
        
        const updateStats = (shouldSave = false) => {
            let stats = JSON.parse(localStorage.getItem('organicReactionsStats')) || { correct: 0, total: 0 };
            if (shouldSave) {
                stats.correct += gameState.score;
                stats.total += gameState.totalQuestions;
                localStorage.setItem('organicReactionsStats', JSON.stringify(stats));
            }
            const percentage = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(0) : 0;
            DOMElements.displays.stats.innerHTML = `Acertadas: <span class="font-bold text-md text-correct">${stats.correct} / ${stats.total}</span> (${percentage}%)`;
        };

        const showConfirmationModal = () => {
            DOMElements.modal.container.classList.remove('hidden');
            setTimeout(() => {
                DOMElements.modal.container.classList.remove('opacity-0');
                DOMElements.modal.dialog.classList.remove('scale-95');
            }, 10);
        };
        
        const hideConfirmationModal = () => {
            DOMElements.modal.container.classList.add('opacity-0');
            DOMElements.modal.dialog.classList.add('scale-95');
            setTimeout(() => {
                DOMElements.modal.container.classList.add('hidden');
            }, 300);
        };

        const handleResetStats = () => {
            localStorage.removeItem('organicReactionsStats');
            updateStats();
            hideConfirmationModal();
        };

        const updateProgressBar = () => {
            const progress = (gameState.currentQuestion / gameState.totalQuestions) * 100;
            DOMElements.displays.progressBar.style.width = `${progress}%`;
        };

        // --- CONFIGURACIÓN INICIAL Y EVENT LISTENERS ---
        const initialize = () => {
            const setupSelector = (selector, stateKey, callback) => {
                selector.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (button && button.dataset[stateKey]) {
                        const value = parseInt(button.dataset[stateKey]);
                        callback(value);
                        selector.querySelectorAll('button').forEach(btn => btn.classList.remove('selected-option'));
                        button.classList.add('selected-option');
                    }
                });
            };

            setupSelector(DOMElements.selectors.level, 'level', (level) => {
                gameState.level = level;
                setTheme(level);
            });

            setupSelector(DOMElements.selectors.questionCount, 'count', (count) => {
                gameState.totalQuestions = count;
            });

            DOMElements.buttons.start.addEventListener('click', startGame);
            DOMElements.buttons.check.addEventListener('click', checkAnswer);
            DOMElements.buttons.nextQuestion.addEventListener('click', () => {
                gameState.currentQuestion++;
                displayNextQuestion();
            });
            DOMElements.buttons.playAgain.addEventListener('click', startGame);
            DOMElements.buttons.mainMenu.addEventListener('click', () => showView('mainMenu'));
            DOMElements.buttons.back.addEventListener('click', () => showView('mainMenu'));
            DOMElements.buttons.resetStats.addEventListener('click', showConfirmationModal);
            DOMElements.buttons.confirmReset.addEventListener('click', handleResetStats);
            DOMElements.buttons.cancelReset.addEventListener('click', hideConfirmationModal);
            DOMElements.modal.container.addEventListener('click', (e) => {
                if (e.target === DOMElements.modal.container) hideConfirmationModal();
            });

            // Estado inicial
            DOMElements.selectors.level.querySelector('[data-level="1"]').click();
            DOMElements.selectors.questionCount.querySelector('[data-count="5"]').click();
            updateStats();
            showView('mainMenu');
        };

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>


