<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reacciones Orgánicas Challenge</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Lexend -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Paleta de colores más suaves */
            --theme-color-600: #0d9488; /* teal-600 */
            --theme-color-800: #0f766e; /* teal-800 */
            --theme-shadow-color: 'rgba(20, 184, 166, 0.5)';
            --theme-focus-ring-color: #14b8a6; /* teal-500 */
            --theme-bg-from: #6ee7b7; /* emerald-300 */
            --theme-bg-to: #bae6fd; /* sky-200 */
            --btn-gradient-from: #14b8a6; /* teal-500 */
            --btn-gradient-to: #059669; /* emerald-600 */
            /* Color de acento para el progreso y el contador */
            --accent-color: #facc15;
            --accent-shadow-color: 'rgba(250, 204, 21, 0.5)';
            
            /* Colores para las estadísticas */
            --stats-correct-color: #16a34a; /* green-600 */
            --stats-total-color: #64748b; /* slate-500 */
            --stats-percentage-color: #f59e0b; /* amber-500 */
        }

        body { 
            font-family: 'Lexend', sans-serif; 
            background-image: linear-gradient(to right, var(--theme-bg-from), var(--theme-bg-to)); 
            transition: background 0.5s ease-in-out; 
        }
        
        /* Estilo de Glassmorphism */
        .glass-container {
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        .btn-primary { 
            background: linear-gradient(to right, var(--btn-gradient-from), var(--btn-gradient-to)); 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .btn-primary:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 4px 6px -1px var(--theme-shadow-color), 0 2px 4px -1px var(--theme-shadow-color); 
        }
        
        .selected-option {
            background-color: var(--theme-color-600);
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .text-theme { color: var(--theme-color-600); }
        .ring-theme:focus { --tw-ring-color: var(--theme-focus-ring-color); }
        .text-accent { color: var(--accent-color); }
        
        /* Asegura que el font de los inputs sea el mismo */
        input {
            font-family: 'Lexend', sans-serif; 
        }

        /* Estilo para los subíndices */
        .reaction-formula sub, .reaction-formula sup {
            vertical-align: sub;
            font-size: 0.8em;
        }

        /* Estilo para la barra de progreso */
        #progress-bar {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 9999px;
            overflow: hidden;
            transition: width 0.3s ease-in-out;
        }

        #progress-bar-fill {
            height: 100%;
            background-color: var(--accent-color);
            transition: width 0.3s ease-in-out;
        }
        
        /* Eliminamos los estilos de las burbujas */
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center relative">
    <!-- Eliminamos el HTML de las burbujas -->

    <!-- Reducimos el padding vertical del menú principal de p-8 a p-6 -->
    <div id="main-menu" class="glass-container p-6 rounded-2xl w-full max-w-sm md:max-w-xl text-center transform scale-100 transition-transform duration-300">
        <h1 class="text-4xl font-extrabold text-theme mb-4">Reacciones Orgánicas Challenge</h1>
        
        <!-- Marcador de estadísticas globales en una caja -->
        <div class="mb-6 pt-4 px-6 pb-2 glass-container rounded-lg border-none shadow-md">
            <!-- Reducimos el tamaño del texto de 'Marcador Global' de text-xl a text-lg -->
            <h3 class="text-lg font-bold text-gray-700 mb-2">Marcador Global</h3>
            <div id="stats-display" class="text-gray-600 text-sm flex justify-center items-center space-x-4">
                <p>Correctas: <span class="text-stats-correct font-bold">0</span> de <span class="text-stats-total font-bold">0</span></p>
                <p>Porcentaje: <span class="text-stats-percentage font-bold">0%</span></p>
                <button id="reset-stats-btn" class="text-gray-400 hover:text-red-500 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline-block">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.93a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.06-2.09.91-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Selecciona el nivel</h3>
            <div id="level-selector" class="flex justify-center space-x-4">
                <button data-level="1" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-semibold transition-colors duration-200 hover:bg-gray-200">Nivel 1</button>
                <button data-level="2" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-semibold transition-colors duration-200 hover:bg-gray-200">Nivel 2</button>
                <button data-level="3" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-semibold transition-colors duration-200 hover:bg-gray-200">Nivel 3</button>
            </div>
        </div>

        <div class="mb-8">
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Número de ejercicios</h3>
            <div id="question-count-selector" class="flex justify-center space-x-4">
                <button data-count="10" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-semibold transition-colors duration-200 hover:bg-gray-200">10</button>
                <button data-count="15" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-semibold transition-colors duration-200 hover:bg-gray-200">15</button>
                <button data-count="20" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600 font-semibold transition-colors duration-200 hover:bg-gray-200">20</button>
            </div>
        </div>

        <button id="start-game-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg">Empezar</button>
    </div>

    <!-- Mantenemos la vista de juego, pero modificamos su contenido para mostrar la retroalimentación -->
    <div id="game-view" class="glass-container p-8 rounded-2xl w-full max-w-sm md:max-w-xl text-center hidden transform scale-0 transition-transform duration-300 overflow-y-auto">
        <!-- Botón de atrás y barra de progreso -->
        <div class="flex items-center justify-between mb-4">
            <button id="back-btn" class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
            </button>
            <span id="score-display" class="text-xl font-bold text-gray-700">Puntuación: 0</span>
            <span id="question-count" class="text-xl font-bold text-accent">1/10</span>
        </div>
        <div class="mb-8">
            <div id="progress-bar">
                <div id="progress-bar-fill"></div>
            </div>
        </div>
        
        <div id="reaction-container" class="mb-6">
            <p id="reaction-text" class="text-2xl font-bold text-red-500 reaction-formula">Reactivos + ? → Productos</p>
        </div>
        
        <!-- Contenedor de las preguntas -->
        <div class="space-y-4 text-left">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="w-full" id="product-container">
                    <label class="block text-gray-700 font-semibold mb-2" for="product-input">Fórmula del compuesto:</label>
                    <input id="product-input" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none ring-theme focus:ring-2 transition-colors duration-200 font-lexend">
                </div>
                <div class="w-full" id="name-container">
                    <label class="block text-gray-700 font-semibold mb-2" for="name-input">Nombre del compuesto:</label>
                    <input id="name-input" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none ring-theme focus:ring-2 transition-colors duration-200 font-lexend">
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                <div class="w-full" id="reaction-type-container">
                    <label class="block text-gray-700 font-semibold mb-2" for="reaction-type-input">Tipo de reacción:</label>
                    <input id="reaction-type-input" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none ring-theme focus:ring-2 transition-colors duration-200 font-lexend">
                </div>
                <div class="w-full" id="category-container">
                    <label class="block text-gray-700 font-semibold mb-2" for="category-input">Categoría:</label>
                    <input id="category-input" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none ring-theme focus:ring-2 transition-colors duration-200 font-lexend">
                </div>
            </div>

            <div class="w-full hidden" id="catalyst-container">
                <label class="block text-gray-700 font-semibold mb-2" for="catalyst-input">Catalizador:</label>
                <input id="catalyst-input" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none ring-theme focus:ring-2 transition-colors duration-200 font-lexend">
            </div>
        </div>

        <button id="check-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg mt-8 w-full">Comprobar</button>
        
        <!-- Contenedor para mostrar la retroalimentación y la respuesta correcta en la misma pantalla -->
        <div id="feedback-display" class="mt-4 hidden">
            <!-- Reducimos el tamaño del texto de retroalimentación de text-3xl a text-2xl -->
            <h2 id="feedback-message" class="text-2xl font-bold text-theme mb-4"></h2>
            <!-- Reducimos el tamaño del texto de respuesta correcta de text-xl a text-base -->
            <div id="correct-answer" class="text-base text-gray-700 mb-8 text-left"></div>
            <button id="next-question-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg w-full">Siguiente Pregunta</button>
        </div>
    </div>

    <!-- Eliminamos la vista de retroalimentación ya que ahora se muestra en la vista de juego -->

    <div id="game-over" class="glass-container p-8 rounded-2xl w-full max-w-sm md:max-w-xl text-center hidden transform scale-0 transition-transform duration-300">
        <h2 class="text-3xl font-bold text-theme mb-4">¡Partida Terminada!</h2>
        <p id="final-score" class="text-xl text-gray-700 mb-8"></p>
        <button id="play-again-btn" class="btn-primary text-white font-bold py-3 px-10 rounded-lg text-lg">Jugar de Nuevo</button>
    </div>

    <script>
        // Base de datos de reacciones químicas ampliada y actualizada para la PAU de Andalucía
        const organicReactions = [
            // Nivel 1 & 2: Completa los productos (Reacciones más comunes)
            { id: 1, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-OH + HBr → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-Br', compoundName: 'Bromoetano', reactionType: 'Sustitución', category: 'Halogenación', catalyst: '—', type: 'complete' },
            { id: 2, reaction: 'CH<sub>3</sub>-CH=CH<sub>2</sub> + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>3</sub>', compoundName: 'Propano', reactionType: 'Adición', category: 'Hidrogenación', catalyst: 'Ni/Pt/Pd', type: 'complete' },
            { id: 3, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-Br + NaOH → ? + NaBr', product: 'CH<sub>2</sub>=CH<sub>2</sub>', compoundName: 'Eteno', reactionType: 'Eliminación', category: null, catalyst: '—', type: 'complete' },
            { id: 4, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-OH + H<sub>2</sub>SO<sub>4</sub> → ?', product: 'CH<sub>2</sub>=CH<sub>2</sub>', compoundName: 'Eteno', reactionType: 'Eliminación', category: 'Deshidratación', catalyst: 'Calor', type: 'complete' },
            { id: 5, reaction: 'CH<sub>3</sub>-COOH + CH<sub>3</sub>OH → ? + H<sub>2</sub>O', product: 'CH<sub>3</sub>-COO-CH<sub>3</sub>', compoundName: 'Etanoato de metilo', reactionType: 'Esterificación', category: null, catalyst: 'H+', type: 'complete' },
            { id: 6, reaction: 'CH<sub>3</sub>-CH=CH<sub>2</sub> + H<sub>2</sub>O → ?', product: 'CH<sub>3</sub>-CH(OH)-CH<sub>3</sub>', compoundName: 'Propan-2-ol', reactionType: 'Adición', category: 'Hidratación', catalyst: 'H+', type: 'complete' },
            { id: 7, reaction: 'CH<sub>3</sub>-CHO + [O] → ?', product: 'CH<sub>3</sub>-COOH', compoundName: 'Ácido etanoico', reactionType: 'Oxidación', category: null, catalyst: '—', type: 'complete' },
            { id: 8, reaction: 'CH<sub>3</sub>-CO-CH<sub>3</sub> + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH(OH)-CH<sub>3</sub>', compoundName: 'Propan-2-ol', reactionType: 'Reducción', category: null, catalyst: 'Ni/Pt/Pd', type: 'complete' },
            { id: 9, reaction: 'CH<sub>3</sub>-CH=CH<sub>2</sub> + HCl → ?', product: 'CH<sub>3</sub>-CHCl-CH<sub>3</sub>', compoundName: '2-Cloropropano', reactionType: 'Adición', category: 'Haluros de Hidrógeno', catalyst: '—', type: 'complete' },
            { id: 10, reaction: 'C<sub>6</sub>H<sub>6</sub> + HNO<sub>3</sub> → ? + H<sub>2</sub>O', product: 'C<sub>6</sub>H<sub>5</sub>-NO<sub>2</sub>', compoundName: 'Nitrobenceno', reactionType: 'Sustitución', category: null, catalyst: 'H<sub>2</sub>SO<sub>4</sub>', type: 'complete' },
            { id: 11, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-OH + K<sub>2</sub>Cr<sub>2</sub>O<sub>7</sub> → ?', product: 'CH<sub>3</sub>-CHO', compoundName: 'Etanal', reactionType: 'Oxidación', category: null, catalyst: 'H+', type: 'complete' },
            { id: 12, reaction: 'CH<sub>3</sub>-CH<sub>3</sub> + Cl<sub>2</sub> → ? + HCl', product: 'CH<sub>3</sub>-CH<sub>2</sub>Cl', compoundName: 'Cloroetano', reactionType: 'Sustitución', category: 'Halogenación', catalyst: 'Luz UV', type: 'complete' },
            { id: 13, reaction: 'CH<sub>3</sub>-CH=CH-CH<sub>3</sub> + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>2</sub>-CH<sub>3</sub>', compoundName: 'Butano', reactionType: 'Adición', category: 'Hidrogenación', catalyst: 'Ni/Pt/Pd', type: 'complete' },
            { id: 14, reaction: 'CH<sub>3</sub>-CH=CH<sub>2</sub> + Cl<sub>2</sub> → ?', product: 'ClCH<sub>2</sub>-CHCl-CH<sub>3</sub>', compoundName: '1,2-Dicloropropano', reactionType: 'Adición', category: 'Halogenación', catalyst: '—', type: 'complete' },
            { id: 15, reaction: 'CH<sub>3</sub>-C≡CH + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH=CH<sub>2</sub>', compoundName: 'Propeno', reactionType: 'Adición', category: 'Hidrogenación', catalyst: 'Lindlar', type: 'complete' },
            { id: 16, reaction: 'CH<sub>3</sub>-C≡CH + 2H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>3</sub>', compoundName: 'Propano', reactionType: 'Adición', category: 'Hidrogenación', catalyst: 'Ni/Pt/Pd', type: 'complete' },
            { id: 17, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>2</sub>Cl + NaOH → ? + NaCl', product: 'CH<sub>3</sub>-CH=CH<sub>2</sub>', compoundName: 'Propeno', reactionType: 'Eliminación', category: null, catalyst: '—', type: 'complete' },
            { id: 18, reaction: 'CH<sub>3</sub>-CH(OH)-CH<sub>3</sub> + H<sub>2</sub>SO<sub>4</sub> → ?', product: 'CH<sub>3</sub>-CH=CH<sub>2</sub>', compoundName: 'Propeno', reactionType: 'Eliminación', category: 'Deshidratación', catalyst: 'Calor', type: 'complete' },
            { id: 19, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>2</sub>OH + [O] → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-COOH', compoundName: 'Ácido propanoico', reactionType: 'Oxidación', category: null, catalyst: '—', type: 'complete' },
            { id: 20, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CHO + [O] → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-COOH', compoundName: 'Ácido propanoico', reactionType: 'Oxidación', category: null, catalyst: '—', type: 'complete' },
            { id: 21, reaction: 'CH<sub>3</sub>-CH(OH)-CH<sub>3</sub> + [O] → ?', product: 'CH<sub>3</sub>-CO-CH<sub>3</sub>', compoundName: 'Propanona', reactionType: 'Oxidación', category: null, catalyst: '—', type: 'complete' },
            { id: 22, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-COOH + CH<sub>3</sub>-CH<sub>2</sub>OH → ? + H<sub>2</sub>O', product: 'CH<sub>3</sub>-CH<sub>2</sub>-COO-CH<sub>2</sub>-CH<sub>3</sub>', compoundName: 'Propanoato de etilo', reactionType: 'Esterificación', category: null, catalyst: 'H+', type: 'complete' },
            { id: 23, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CHO + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>2</sub>OH', compoundName: 'Propan-1-ol', reactionType: 'Reducción', category: null, catalyst: 'Ni/Pt/Pd', type: 'complete' },
            { id: 24, reaction: 'C<sub>6</sub>H<sub>6</sub> + Br<sub>2</sub> → ? + HBr', product: 'C<sub>6</sub>H<sub>5</sub>Br', compoundName: 'Bromobenceno', reactionType: 'Sustitución', category: 'Halogenación', catalyst: 'FeBr<sub>3</sub>', type: 'complete' },
            { id: 25, reaction: 'CH<sub>3</sub>-CH<sub>3</sub> + O<sub>2</sub> → ? + ?', product: 'CO<sub>2</sub> + H<sub>2</sub>O', compoundName: 'Dióxido de carbono y Agua', reactionType: 'Combustión', category: null, catalyst: '—', type: 'complete' },
            { id: 26, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>3</sub> + Br<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CHBr-CH<sub>3</sub>', compoundName: '2-Bromopropano', reactionType: 'Sustitución', category: 'Halogenación', catalyst: 'Luz UV', type: 'complete' },
            { id: 27, reaction: 'CH<sub>2</sub>=CH<sub>2</sub> + HBr → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>Br', compoundName: 'Bromoetano', reactionType: 'Adición', category: 'Haluros de Hidrógeno', catalyst: '—', type: 'complete' },
            { id: 28, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-OH + HIO<sub>4</sub> → ?', product: 'CH<sub>3</sub>-CHO', compoundName: 'Etanal', reactionType: 'Oxidación', category: null, catalyst: '—', type: 'complete' },
            { id: 29, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CH(OH)-CH<sub>3</sub> + K<sub>2</sub>Cr<sub>2</sub>O<sub>7</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CO-CH<sub>3</sub>', compoundName: 'Butanona', reactionType: 'Oxidación', category: null, catalyst: 'H+', type: 'complete' },
            { id: 30, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CHO + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CH<sub>2</sub>OH', compoundName: 'Propan-1-ol', reactionType: 'Reducción', category: null, catalyst: '—', type: 'complete' },
            { id: 31, reaction: 'CH<sub>3</sub>-CH<sub>2</sub>-CO-CH<sub>3</sub> + H<sub>2</sub> → ?', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CH(OH)-CH<sub>3</sub>', compoundName: 'Butan-2-ol', reactionType: 'Reducción', category: null, catalyst: '—', type: 'complete' },

            // Nivel 3: Completa los reactivos (Reacciones más comunes)
            { id: 32, reaction: '? + HCl → CH<sub>3</sub>-CH<sub>2</sub>-Cl', product: 'CH<sub>2</sub>=CH<sub>2</sub>', compoundName: 'Eteno', reactionType: 'Adición', category: 'Haluros de Hidrógeno', catalyst: '—', type: 'reverse' },
            { id: 33, reaction: '? + NaOH → CH<sub>3</sub>-OH + NaBr', product: 'CH<sub>3</sub>-Br', compoundName: 'Bromometano', reactionType: 'Sustitución', category: null, catalyst: '—', type: 'reverse' },
            { id: 34, reaction: '? → CH<sub>2</sub>=CH<sub>2</sub> + H<sub>2</sub>O', product: 'CH<sub>3</sub>-CH<sub>2</sub>-OH', compoundName: 'Etanol', reactionType: 'Eliminación', category: 'Deshidratación', catalyst: 'H<sub>2</sub>SO<sub>4</sub>, calor', type: 'reverse' },
            { id: 35, reaction: '? + H<sub>2</sub>O → CH<sub>3</sub>-COOH + CH<sub>3</sub>OH', product: 'CH<sub>3</sub>-COO-CH<sub>3</sub>', compoundName: 'Etanoato de metilo', reactionType: 'Esterificación', category: null, catalyst: 'H+', type: 'reverse' },
            { id: 36, reaction: '? + [O] → C<sub>6</sub>H<sub>5</sub>-COOH', product: 'C<sub>6</sub>H<sub>5</sub>-CHO', compoundName: 'Benzaldehído', reactionType: 'Oxidación', category: null, catalyst: '—', type: 'reverse' },
            { id: 37, reaction: '? + H<sub>2</sub>O → CH<sub>3</sub>-CH(OH)-CH<sub>3</sub>', product: 'CH<sub>3</sub>-CH=CH<sub>2</sub>', compoundName: 'Propeno', reactionType: 'Adición', category: 'Hidratación', catalyst: 'H+', type: 'reverse' },
            { id: 38, reaction: '? + H<sub>2</sub> → C<sub>6</sub>H<sub>5</sub>-CH<sub>2</sub>-OH', product: 'C<sub>6</sub>H<sub>5</sub>-CHO', compoundName: 'Benzaldehído', reactionType: 'Reducción', category: null, catalyst: 'Ni/Pt/Pd', type: 'reverse' },
            { id: 39, reaction: '? + Br<sub>2</sub> → BrCH<sub>2</sub>-CH<sub>2</sub>Br', product: 'CH<sub>2</sub>=CH<sub>2</sub>', compoundName: 'Eteno', reactionType: 'Adición', category: 'Halogenación', catalyst: '—', type: 'reverse' },
            { id: 40, reaction: '? + H<sub>2</sub>SO<sub>4</sub> → CH<sub>3</sub>-CH=CH-CH<sub>3</sub> + H<sub>2</sub>O', product: 'CH<sub>3</sub>-CH<sub>2</sub>-CH(OH)-CH<sub>3</sub>', compoundName: 'Butan-2-ol', reactionType: 'Eliminación', category: 'Deshidratación', catalyst: 'Calor', type: 'reverse' },
            { id: 41, reaction: '? + H<sub>2</sub> → CH<sub>3</sub>-CH<sub>2</sub>-OH', product: 'CH<sub>3</sub>-CHO', compoundName: 'Etanal', reactionType: 'Reducción', category: null, catalyst: '—', type: 'reverse' },
            { id: 42, reaction: '? → CO<sub>2</sub> + H<sub>2</sub>O', product: 'CH<sub>4</sub>', compoundName: 'Metano', reactionType: 'Combustión', category: null, catalyst: '—', type: 'reverse' },
        ];
        
        // Elementos del DOM
        const allViews = {
            mainMenu: document.getElementById('main-menu'),
            gameView: document.getElementById('game-view'),
            gameOver: document.getElementById('game-over')
        };
        const startBtn = document.getElementById('start-game-btn');
        const backBtn = document.getElementById('back-btn');
        const reactionText = document.getElementById('reaction-text');
        const scoreDisplay = document.getElementById('score-display');
        const questionCountDisplay = document.getElementById('question-count');
        
        // Contenedores de inputs
        const productContainer = document.getElementById('product-container');
        const nameContainer = document.getElementById('name-container');
        const reactionTypeContainer = document.getElementById('reaction-type-container');
        const categoryContainer = document.getElementById('category-container');
        const catalystContainer = document.getElementById('catalyst-container');

        // Inputs
        const productInput = document.getElementById('product-input');
        const nameInput = document.getElementById('name-input');
        const reactionTypeInput = document.getElementById('reaction-type-input');
        const categoryInput = document.getElementById('category-input');
        const catalystInput = document.getElementById('catalyst-input');

        const checkBtn = document.getElementById('check-btn');
        const feedbackDisplay = document.getElementById('feedback-display'); // Nuevo elemento de retroalimentación
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const finalScoreDisplay = document.getElementById('final-score');
        const playAgainBtn = document.getElementById('play-again-btn');
        const statsDisplay = document.getElementById('stats-display');
        const resetStatsBtn = document.getElementById('reset-stats-btn');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const levelSelector = document.getElementById('level-selector');
        const questionCountSelector = document.getElementById('question-count-selector');

        let gameState = {
            currentQuestion: 0,
            score: 0,
            questions: [],
            totalQuestions: 10,
            level: 1,
            currentReaction: null,
            correctAnswerShown: false
        };

        const showView = (view) => {
            Object.values(allViews).forEach(v => {
                v.classList.add('hidden', 'scale-0');
                v.classList.remove('scale-100');
            });
            view.classList.remove('hidden', 'scale-0');
            view.classList.add('scale-100');
        };

        const normalizeValue = (value) => {
            if (!value) return '';
            return value.replace(/<[^>]*>/g, '').toLowerCase().trim();
        };

        const updateStatsDisplay = () => {
            const stats = JSON.parse(localStorage.getItem('organicReactionsStats')) || { correct: 0, total: 0 };
            const correct = stats.correct;
            const total = stats.total;
            const percentage = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;
            
            statsDisplay.innerHTML = `
                <p>Correctas: <span class="text-[var(--stats-correct-color)] font-bold">${correct}</span> de <span class="text-[var(--stats-total-color)] font-bold">${total}</span></p>
                <p>Porcentaje: <span class="text-[var(--stats-percentage-color)] font-bold">${percentage}%</span></p>
            `;
        };

        const updateProgressBar = () => {
            const progress = (gameState.currentQuestion / gameState.totalQuestions) * 100;
            progressBarFill.style.width = `${progress}%`;
        };
        
        const setLevelAndQuestionCount = (level, count) => {
            gameState.level = level;
            gameState.totalQuestions = count;
            
            document.querySelectorAll('#level-selector button').forEach(btn => {
                btn.classList.remove('selected-option');
                if (parseInt(btn.dataset.level) === level) {
                    btn.classList.add('selected-option');
                }
            });
            
            document.querySelectorAll('#question-count-selector button').forEach(btn => {
                btn.classList.remove('selected-option');
                if (parseInt(btn.dataset.count) === count) {
                    btn.classList.add('selected-option');
                }
            });
        };

        const startGame = () => {
            gameState.score = 0;
            gameState.currentQuestion = 0;
            let filteredReactions;
            if (gameState.level < 3) {
                 filteredReactions = organicReactions.filter(r => r.type === 'complete');
            } else {
                 filteredReactions = organicReactions; // Usar todas las reacciones para el nivel 3
            }
            
            gameState.questions = [...filteredReactions].sort(() => Math.random() - 0.5).slice(0, gameState.totalQuestions);
            nextQuestion();
            showView(allViews.gameView);
        };

        const nextQuestion = () => {
            if (gameState.currentQuestion >= gameState.totalQuestions) {
                endGame();
                return;
            }
            gameState.currentReaction = gameState.questions[gameState.currentQuestion];
            
            reactionText.innerHTML = gameState.currentReaction.reaction;
            
            // Ocultamos todos los contenedores al inicio
            productContainer.classList.add('hidden');
            nameContainer.classList.add('hidden');
            reactionTypeContainer.classList.add('hidden');
            categoryContainer.classList.add('hidden');
            catalystContainer.classList.add('hidden');
            
            // Mostramos los inputs según el tipo de reacción y nivel
            if (gameState.currentReaction.type === 'complete') {
                productContainer.classList.remove('hidden');
                nameContainer.classList.remove('hidden');
            } else {
                // Aquí podrías mostrar los inputs para reactivos si los tuvieras
            }

            // Oculta los campos si el nivel no los requiere
            if (gameState.level >= 2) {
                reactionTypeContainer.classList.remove('hidden');
                // Si la reacción no tiene categoría, ocultamos el campo
                if (gameState.currentReaction.category) {
                     categoryContainer.classList.remove('hidden');
                }
            }
            if (gameState.level >= 3) {
                 // Si la reacción tiene catalizador (y no es '—'), muestra el campo
                if (gameState.currentReaction.catalyst && normalizeValue(gameState.currentReaction.catalyst) !== '—') {
                     catalystContainer.classList.remove('hidden');
                }
            }

            scoreDisplay.textContent = `Puntuación: ${gameState.score}`;
            questionCountDisplay.textContent = `${gameState.currentQuestion + 1}/${gameState.totalQuestions}`;
            
            productInput.value = '';
            nameInput.value = '';
            reactionTypeInput.value = '';
            categoryInput.value = '';
            catalystInput.value = '';
            
            // Oculta la retroalimentación
            feedbackDisplay.classList.add('hidden');
            checkBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden');
            
            updateProgressBar();
            showView(allViews.gameView);
        };

        const checkAnswer = () => {
            const currentReaction = gameState.currentReaction;
            const feedbackMessageEl = document.getElementById('feedback-message');
            const correctAnswerDisplayEl = document.getElementById('correct-answer');

            // Función auxiliar para comprobar respuestas con múltiples opciones (ej. Ni/Pt/Pd)
            const checkMultipleOptions = (correctValue, userValue) => {
                if (!correctValue || correctValue === '—') {
                    return !userValue; // Es correcto si el usuario no ingresa nada
                }
                const correctOptions = correctValue.split('/').map(option => normalizeValue(option));
                return correctOptions.includes(normalizeValue(userValue));
            };

            const userProduct = normalizeValue(productInput.value);
            const isProductCorrect = userProduct === normalizeValue(currentReaction.product);

            const userCompoundName = normalizeValue(nameInput.value);
            const isNameCorrect = normalizeValue(currentReaction.compoundName).includes(userCompoundName);

            let isReactionTypeCorrect = true;
            let isCategoryCorrect = true;
            let isCatalystCorrect = true;

            if (gameState.level >= 2) {
                const userReactionType = normalizeValue(reactionTypeInput.value);
                isReactionTypeCorrect = normalizeValue(currentReaction.reactionType).includes(userReactionType);
                
                // Solo comprueba la categoría si la reacción la tiene
                if (currentReaction.category) {
                    const userCategory = normalizeValue(categoryInput.value);
                    isCategoryCorrect = normalizeValue(currentReaction.category).includes(userCategory);
                }
            }
            
            if (gameState.level >= 3) {
                const userCatalyst = normalizeValue(catalystInput.value);
                // Usamos la nueva función para comprobar catalizadores con múltiples opciones
                isCatalystCorrect = checkMultipleOptions(currentReaction.catalyst, userCatalyst);
            }

            const isCorrect = isProductCorrect && isNameCorrect && isReactionTypeCorrect && isCategoryCorrect && isCatalystCorrect;

            if (isCorrect) {
                feedbackMessageEl.textContent = '¡Correcto!';
                feedbackMessageEl.classList.remove('text-red-500');
                feedbackMessageEl.classList.add('text-green-500');
                gameState.score++;
            } else {
                // Eliminamos el punto final
                feedbackMessageEl.textContent = 'Incorrecto';
                feedbackMessageEl.classList.remove('text-green-500');
                feedbackMessageEl.classList.add('text-red-500');
            }

            correctAnswerDisplayEl.innerHTML = `
                <div class="mt-4 p-4 rounded-lg bg-gray-100 border border-gray-300">
                    <!-- Reducimos el tamaño de la fuente para el título -->
                    <p class="font-bold text-gray-800 mb-2">Respuesta Correcta:</p>
                    <p class="text-sm"><strong>Fórmula:</strong> ${currentReaction.product}</p>
                    <p class="text-sm"><strong>Nombre:</strong> ${currentReaction.compoundName}</p>
                    ${gameState.level >= 2 ? `<p class="text-sm"><strong>Tipo:</strong> ${currentReaction.reactionType}</p>` : ''}
                    <!-- Solo mostramos la categoría si existe una en la base de datos -->
                    ${gameState.level >= 2 && currentReaction.category ? `<p class="text-sm"><strong>Categoría:</strong> ${currentReaction.category}</p>` : ''}
                    ${gameState.level >= 3 && normalizeValue(currentReaction.catalyst) !== '—' ? `<p class="text-sm"><strong>Catalizador:</strong> ${currentReaction.catalyst}</p>` : ''}
                </div>
            `;
            
            gameState.currentQuestion++;
            checkBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
            feedbackDisplay.classList.remove('hidden');
        };

        const endGame = () => {
            const stats = JSON.parse(localStorage.getItem('organicReactionsStats')) || { correct: 0, total: 0 };
            stats.correct += gameState.score;
            stats.total += gameState.totalQuestions;
            localStorage.setItem('organicReactionsStats', JSON.stringify(stats));

            finalScoreDisplay.textContent = `Tu puntuación fue: ${gameState.score} de ${gameState.totalQuestions} aciertos.`;
            updateStatsDisplay();
            showView(allViews.gameOver);
        };

        const resetStats = () => {
            localStorage.removeItem('organicReactionsStats');
            updateStatsDisplay();
        };

        // Event Listeners
        startBtn.addEventListener('click', startGame);
        checkBtn.addEventListener('click', checkAnswer);
        nextQuestionBtn.addEventListener('click', nextQuestion);
        playAgainBtn.addEventListener('click', () => showView(allViews.mainMenu));
        backBtn.addEventListener('click', () => showView(allViews.mainMenu));
        resetStatsBtn.addEventListener('click', resetStats);

        levelSelector.addEventListener('click', (e) => {
            if (e.target.dataset.level) {
                setLevelAndQuestionCount(parseInt(e.target.dataset.level), gameState.totalQuestions);
            }
        });
        
        questionCountSelector.addEventListener('click', (e) => {
            if (e.target.dataset.count) {
                setLevelAndQuestionCount(gameState.level, parseInt(e.target.dataset.count));
            }
        });

        // Initial setup
        updateStatsDisplay();
        setLevelAndQuestionCount(2, 10); // Establece el nivel 2 y 10 preguntas por defecto
        showView(allViews.mainMenu);
    </script>
</body>
</html>
